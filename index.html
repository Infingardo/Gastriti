<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gastrite ‚Äì Sistema di Sydney + OLGA/OLGIM</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #1a202c;
      line-height: 1.6;
    }
    header {
      background: white;
      border-bottom: 2px solid #e2e8f0;
      padding: 1.5rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    h1 { font-size: 1.75rem; font-weight: 700; color: #2d3748; margin-bottom: 0.25rem; }
    .subtitle { font-size: 0.9rem; color: #718096; text-transform: uppercase; letter-spacing: 0.05em; }
    
    .info-panel {
      background: #edf2f7;
      border-left: 4px solid #4299e1;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }
    .info-panel strong { color: #2b6cb0; }
    
    .settings {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .settings label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      margin: 0.5rem 0;
    }
    .settings input[type="radio"] { accent-color: #4299e1; cursor: pointer; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1rem 0; }
    
    .card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card h2 { font-size: 1.1rem; color: #2d3748; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
    .card.global { background: #f0f9ff; border: 2px solid #90cdf4; }
    .card.global h2 { color: #2b6cb0; border-bottom-color: #90cdf4; }
    
    .field { margin-bottom: 1rem; }
    .field label { 
      display: block; 
      font-size: 0.85rem; 
      font-weight: 600; 
      color: #4a5568; 
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .field select {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #cbd5e0;
      border-radius: 0.375rem;
      font-size: 0.95rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .field select:focus { outline: none; border-color: #4299e1; }
    .field select.error { border-color: #f56565; background: #fff5f5; }
    .field select.optional { border-style: dashed; }
    .field small { display: block; color: #718096; font-size: 0.8rem; margin-top: 0.25rem; }
    
    .controls {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    button.primary { background: #4299e1; color: white; }
    button.primary:hover { background: #3182ce; }
    button.secondary { background: #e2e8f0; color: #2d3748; }
    button.secondary:hover { background: #cbd5e0; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .alert {
      padding: 1rem;
      border-radius: 0.375rem;
      margin: 1rem 0;
      display: none;
    }
    .alert.error { background: #fff5f5; border-left: 4px solid #f56565; color: #c53030; }
    .alert.success { background: #f0fff4; border-left: 4px solid #48bb78; color: #22543d; }
    .alert.warning { background: #fffaf0; border-left: 4px solid #ed8936; color: #7c2d12; }
    .alert.show { display: block; }
    
    .results {
      background: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .badges {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .badge.low { background: #c6f6d5; color: #22543d; }
    .badge.high { background: #fed7d7; color: #c53030; }
    .badge.info { background: #bee3f8; color: #2c5282; }
    .badge.warning { background: #feebc8; color: #7c2d12; }
    .badge.dysplasia { background: #e9d8fd; color: #553c9a; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    td { font-size: 0.95rem; }
    
    .report-box {
      background: #f7fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin: 1rem 0;
      white-space: pre-wrap;
      font-family: ui-monospace, monospace;
      font-size: 0.9rem;
      line-height: 1.8;
    }
    
    .footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid #e2e8f0;
      font-size: 0.85rem;
      color: #718096;
    }
    .footer a { color: #4299e1; text-decoration: none; font-weight: 500; }
    .footer a:hover { text-decoration: underline; }
    
    .biblio-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }
    .biblio-item {
      margin: 0.5rem 0;
      padding-left: 1rem;
    }
    
    .matrix-note {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 0.85rem;
    }
    
    @media print {
      header, .controls, .settings, .alert { display: none !important; }
      body { background: white; }
      .card, .results { box-shadow: none; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>üî¨ Gastrite ‚Äì Sistema di Sydney + OLGA/OLGIM</h1>
      <div class="subtitle">Tool per refertazione istologica v2.1</div>
    </div>
  </header>
  
  <main class="container">
    <div class="info-panel">
      <strong>Scala Sydney:</strong> 0 = assente ¬∑ 1 = lieve ¬∑ 2 = moderata ¬∑ 3 = severa<br>
      <strong>Nota:</strong> L'incisura angolare viene aggregata all'antro per il calcolo OLGA/OLGIM (max tra i due valori)
    </div>
    
    <div class="settings">
      <strong style="display: block; margin-bottom: 0.5rem;">Metodo di calcolo OLGA:</strong>
      <label>
        <input type="radio" name="olga_method" value="atrophy" checked>
        Solo atrofia ghiandolare (approccio conservativo, OLGA originale)
      </label>
      <label>
        <input type="radio" name="olga_method" value="max">
        Massimo tra atrofia e metaplasia per sede (pi√π sensibile)
      </label>
      <label>
        <input type="radio" name="olga_method" value="combined">
        Atrofia + Metaplasia combinati (se atrofia ‚â•1 OR metaplasia ‚â•1)
      </label>
    </div>
    
    <div id="errorAlert" class="alert error"></div>
    <div id="successAlert" class="alert success"></div>
    <div id="warningAlert" class="alert warning"></div>
    
    <!-- Card globale per displasia e tipo MI -->
    <div class="card global">
      <h2>Valutazione globale</h2>
      <div class="grid" style="margin: 0;">
        <div class="field">
          <label>Displasia</label>
          <select id="dysplasia">
            <option value="">‚Äî</option>
            <option value="0">Assente</option>
            <option value="1">Basso grado (LGD)</option>
            <option value="2">Alto grado (HGD)</option>
          </select>
          <small>Campo obbligatorio per stratificazione rischio MAPS II</small>
        </div>
        <div class="field">
          <label>Tipo metaplasia intestinale (se presente)</label>
          <select id="mi_type" class="optional">
            <option value="">Non applicabile / Non valutato</option>
            <option value="complete">Completa (tipo I)</option>
            <option value="incomplete">Incompleta (tipo II/III)</option>
            <option value="mixed">Mista</option>
          </select>
          <small>Opzionale ‚Äì MI incompleta associata a rischio maggiore</small>
        </div>
      </div>
    </div>
    
    <div class="grid">
      <div class="card">
        <h2>Antro</h2>
        <div class="field">
          <label>Infiltrato cronico</label>
          <select id="an_chronic">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
        <div class="field">
          <label>Attivit√† (neutrofili)</label>
          <select id="an_activity">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Atrofia ghiandolare</label>
          <select id="an_atrophy">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Metaplasia intestinale</label>
          <select id="an_metaplasia">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Helicobacter pylori</label>
          <select id="an_hp">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <h2>Corpo</h2>
        <div class="field">
          <label>Infiltrato cronico</label>
          <select id="co_chronic">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
        <div class="field">
          <label>Attivit√† (neutrofili)</label>
          <select id="co_activity">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Atrofia ghiandolare</label>
          <select id="co_atrophy">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Metaplasia intestinale</label>
          <select id="co_metaplasia">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Helicobacter pylori</label>
          <select id="co_hp">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <h2>Incisura angolare</h2>
        <div class="field">
          <label>Infiltrato cronico</label>
          <select id="in_chronic">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
        <div class="field">
          <label>Attivit√† (neutrofili)</label>
          <select id="in_activity">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Atrofia ghiandolare</label>
          <select id="in_atrophy">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Metaplasia intestinale</label>
          <select id="in_metaplasia">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Helicobacter pylori</label>
          <select id="in_hp">
            <option value="">‚Äî</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="controls">
      <button class="primary" onclick="calculate()">üìä Calcola referto</button>
      <button class="secondary" onclick="copyReport()">üìã Copia referto</button>
      <button class="secondary" onclick="window.print()">üñ®Ô∏è Stampa/PDF</button>
      <button class="secondary" onclick="resetForm()">üîÑ Reset</button>
    </div>
    
    <div id="resultsSection" class="results" style="display: none;">
      <h2 style="margin-bottom: 1rem;">Risultati</h2>
      
      <div id="badgesContainer" class="badges"></div>
      
      <table>
        <thead>
          <tr>
            <th>Sede</th>
            <th>Infiltr. cronico</th>
            <th>Attivit√†</th>
            <th>Atrofia</th>
            <th>Metaplasia</th>
            <th>H. pylori</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      
      <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Referto istologico</h3>
      <div id="reportText" class="report-box"></div>
      
      <div class="footer">
        <p><strong>‚ö†Ô∏è Nota clinica:</strong> Gli stadi OLGA/OLGIM stratificano il rischio di adenocarcinoma gastrico. Stadi III-IV richiedono sorveglianza endoscopica secondo linee guida MAPS/ESGE. La presenza di displasia modifica significativamente il management.</p>
        
        <div class="biblio-section">
          <strong>Riferimenti bibliografici:</strong>
          <div class="biblio-item">
            ‚Ä¢ Dixon MF et al. Classification and grading of gastritis. The updated Sydney System. 
            <em>Am J Surg Pathol</em> 1996;20(10):1161-81. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/8827022/" target="_blank" rel="noopener">PMID:8827022</a>
          </div>
          <div class="biblio-item">
            ‚Ä¢ Rugge M et al. Gastritis staging in clinical practice: the OLGA staging system. 
            <em>Gut</em> 2007;56(5):631-6. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/17142647/" target="_blank" rel="noopener">PMID:17142647</a>
          </div>
          <div class="biblio-item">
            ‚Ä¢ Rugge M et al. OLGA gastritis staging for the assessment of gastric cancer risk: a twelve-year clinico-pathological follow-up study. 
            <em>Dig Liver Dis</em> 2010;42(3):177-82. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/19793674/" target="_blank" rel="noopener">PMID:19793674</a>
          </div>
          <div class="biblio-item">
            ‚Ä¢ Capelle LG et al. The staging of gastritis with the OLGA system by using intestinal metaplasia as an accurate alternative for atrophic gastritis. 
            <em>Gastrointest Endosc</em> 2010;71(7):1150-8. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/20381801/" target="_blank" rel="noopener">PMID:20381801</a>
          </div>
          <div class="biblio-item">
            ‚Ä¢ Capelle LG et al. Staging gastritis with the OLGIM: a less complex alternative to OLGA gastritis staging. 
            <em>Am J Surg Pathol</em> 2010;34(11):1653-64. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/20975341/" target="_blank" rel="noopener">PMID:20975341</a>
          </div>
          <div class="biblio-item">
            ‚Ä¢ Pimentel-Nunes P et al. Management of epithelial precancerous conditions and lesions in the stomach (MAPS II): European Society of Gastrointestinal Endoscopy, European Helicobacter and Microbiota Study Group, European Society of Pathology, and Sociedade Portuguesa de Endoscopia Digestiva Guideline Update 2019. 
            <em>Endoscopy</em> 2019;51(4):365-388. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/30841008/" target="_blank" rel="noopener">PMID:30841008</a>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    // Matrice OLGA originale (Rugge et al. 2007)
    // Righe: corpo (0-3), Colonne: antro (0-3)
    const OLGA_MATRIX = [
      ['0',  'I',   'II',  'II' ],  // corpo 0
      ['I',  'I',   'II',  'III'],  // corpo 1
      ['II', 'II',  'III', 'IV' ],  // corpo 2
      ['II', 'III', 'IV',  'IV' ]   // corpo 3
    ];
    
    function getValue(id) {
      const el = document.getElementById(id);
      return el && el.value !== '' ? parseInt(el.value, 10) : null;
    }
    
    function getStringValue(id) {
      const el = document.getElementById(id);
      return el ? el.value : '';
    }
    
    function showAlert(type, message) {
      const alertId = type === 'error' ? 'errorAlert' : type === 'warning' ? 'warningAlert' : 'successAlert';
      const alert = document.getElementById(alertId);
      alert.textContent = message;
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 6000);
    }
    
    function clearErrors() {
      document.querySelectorAll('select.error').forEach(el => el.classList.remove('error'));
      document.getElementById('errorAlert').classList.remove('show');
      document.getElementById('warningAlert').classList.remove('show');
    }
    
    function validate() {
      clearErrors();
      const fields = [
        'an_chronic', 'an_activity', 'an_atrophy', 'an_metaplasia', 'an_hp',
        'co_chronic', 'co_activity', 'co_atrophy', 'co_metaplasia', 'co_hp',
        'in_chronic', 'in_activity', 'in_atrophy', 'in_metaplasia', 'in_hp',
        'dysplasia'
      ];
      
      const missing = fields.filter(id => getValue(id) === null);
      
      if (missing.length > 0) {
        missing.forEach(id => document.getElementById(id).classList.add('error'));
        showAlert('error', `‚ö†Ô∏è Compila tutti i campi obbligatori (${missing.length} mancanti)`);
        return false;
      }
      return true;
    }
    
    function getOLGAScore(atrophy, metaplasia, method) {
      if (method === 'atrophy') return atrophy;
      if (method === 'max') return Math.max(atrophy, metaplasia);
      if (method === 'combined') {
        return (atrophy >= 1 || metaplasia >= 1) ? Math.max(atrophy, metaplasia) : 0;
      }
      return atrophy;
    }
    
    // Calcolo stadio usando la matrice OLGA corretta
    function calculateStage(antrumScore, corpusScore) {
      // Clamp dei valori a 0-3
      const a = Math.min(3, Math.max(0, antrumScore));
      const c = Math.min(3, Math.max(0, corpusScore));
      return OLGA_MATRIX[c][a];
    }
    
    function getTopography(anChronic, coChronic) {
      // Topografia basata solo su infiltrato cronico (pi√π appropriato clinicamente)
      if (anChronic <= 1 && coChronic <= 1) return 'minima attivit√† infiammatoria';
      const diff = anChronic - coChronic;
      if (Math.abs(diff) <= 1) return 'pangastrite';
      return diff > 0 ? 'prevalentemente antrale' : 'prevalentemente corpale';
    }
    
    function gradeText(val) {
      const words = ['assente', 'lieve', 'moderata', 'severa'];
      return words[val] || '?';
    }
    
    function getRiskLevel(stage) {
      if (stage === 'III' || stage === 'IV') return 'alto';
      if (stage === '0' || stage === 'I' || stage === 'II') return 'basso';
      return 'indeterminato';
    }
    
    function getDysplasiaText(val) {
      if (val === 0) return 'Assente';
      if (val === 1) return 'Basso grado (LGD)';
      if (val === 2) return 'Alto grado (HGD)';
      return '?';
    }
    
    function getMITypeText(val) {
      if (val === 'complete') return 'Completa (tipo I)';
      if (val === 'incomplete') return 'Incompleta (tipo II/III)';
      if (val === 'mixed') return 'Mista (completa + incompleta)';
      return 'Non valutato';
    }
    
    function calculate() {
      if (!validate()) return;
      
      const method = document.querySelector('input[name="olga_method"]:checked').value;
      const dysplasia = getValue('dysplasia');
      const miType = getStringValue('mi_type');
      
      const data = {
        antrum: {
          chronic: getValue('an_chronic'),
          activity: getValue('an_activity'),
          atrophy: getValue('an_atrophy'),
          metaplasia: getValue('an_metaplasia'),
          hp: getValue('an_hp')
        },
        corpus: {
          chronic: getValue('co_chronic'),
          activity: getValue('co_activity'),
          atrophy: getValue('co_atrophy'),
          metaplasia: getValue('co_metaplasia'),
          hp: getValue('co_hp')
        },
        incisura: {
          chronic: getValue('in_chronic'),
          activity: getValue('in_activity'),
          atrophy: getValue('in_atrophy'),
          metaplasia: getValue('in_metaplasia'),
          hp: getValue('in_hp')
        }
      };
      
      // Aggregazione incisura all'antro: prendi il max tra antro e incisura
      const antrumAtrophyAggregated = Math.max(data.antrum.atrophy, data.incisura.atrophy);
      const antrumMetaplasiaAggregated = Math.max(data.antrum.metaplasia, data.incisura.metaplasia);
      
      // OLGA scores per sede (con incisura aggregata all'antro)
      const olgaAntrum = getOLGAScore(antrumAtrophyAggregated, antrumMetaplasiaAggregated, method);
      const olgaCorpus = getOLGAScore(data.corpus.atrophy, data.corpus.metaplasia, method);
      const olgaStage = calculateStage(olgaAntrum, olgaCorpus);
      
      // OLGIM scores (solo metaplasia intestinale, con incisura aggregata)
      const olgimAntrum = antrumMetaplasiaAggregated;
      const olgimCorpus = data.corpus.metaplasia;
      const olgimStage = calculateStage(olgimAntrum, olgimCorpus);
      
      // Topografia basata su infiltrato cronico
      const maxAntrumChronic = Math.max(data.antrum.chronic, data.incisura.chronic);
      const topography = getTopography(maxAntrumChronic, data.corpus.chronic);
      
      const olgaRisk = getRiskLevel(olgaStage);
      const olgimRisk = getRiskLevel(olgimStage);
      const isHighRisk = olgaRisk === 'alto' || olgimRisk === 'alto';
      
      // Calcola discordanza tra OLGA e OLGIM
      const stageValues = { '0': 0, 'I': 1, 'II': 2, 'III': 3, 'IV': 4 };
      const stageDiff = Math.abs(stageValues[olgaStage] - stageValues[olgimStage]);
      const hasDiscordance = stageDiff >= 2;
      
      // Verifica se c'√® metaplasia in qualche sede
      const hasMetaplasia = antrumMetaplasiaAggregated > 0 || data.corpus.metaplasia > 0;
      
      // Badges
      const olgaBadgeClass = olgaRisk === 'alto' ? 'high' : 'low';
      const olgimBadgeClass = olgimRisk === 'alto' ? 'high' : 'low';
      
      let badgesHTML = `
        <span class="badge ${olgaBadgeClass}">
          <span class="dot" style="background: ${olgaRisk === 'alto' ? '#f56565' : '#48bb78'}"></span>
          OLGA ${olgaStage}
        </span>
        <span class="badge ${olgimBadgeClass}">
          <span class="dot" style="background: ${olgimRisk === 'alto' ? '#f56565' : '#48bb78'}"></span>
          OLGIM ${olgimStage}
        </span>
        <span class="badge info">
          <span class="dot" style="background: #4299e1"></span>
          ${topography}
        </span>
      `;
      
      if (dysplasia > 0) {
        const dysplasiaBadgeClass = dysplasia === 2 ? 'high' : 'dysplasia';
        badgesHTML += `
          <span class="badge ${dysplasiaBadgeClass}">
            <span class="dot" style="background: ${dysplasia === 2 ? '#f56565' : '#805ad5'}"></span>
            Displasia ${dysplasia === 1 ? 'LGD' : 'HGD'}
          </span>
        `;
      }
      
      if (hasDiscordance) {
        badgesHTML += `
          <span class="badge warning">
            <span class="dot" style="background: #ed8936"></span>
            Discordanza OLGA/OLGIM
          </span>
        `;
        showAlert('warning', '‚ö†Ô∏è OLGA e OLGIM divergono ‚â•2 stadi: considerare lo stadio pi√π alto per la sorveglianza');
      }
      
      document.getElementById('badgesContainer').innerHTML = badgesHTML;
      
      // Tabella
      const sites = [
        ['Antro', data.antrum],
        ['Corpo', data.corpus],
        ['Incisura', data.incisura]
      ];
      
      document.getElementById('tableBody').innerHTML = sites.map(([name, d]) => `
        <tr>
          <td><strong>${name}</strong></td>
          <td>${d.chronic}</td>
          <td>${d.activity}</td>
          <td>${d.atrophy}</td>
          <td>${d.metaplasia}</td>
          <td>${d.hp}</td>
        </tr>
      `).join('');
      
      // Referto
      const hpMax = Math.max(data.antrum.hp, data.corpus.hp, data.incisura.hp);
      const hpStatus = hpMax > 0 ? 
        `Presenza di Helicobacter pylori (grado ${hpMax})` : 
        'Assenza di Helicobacter pylori';
      
      const methodDesc = {
        'atrophy': 'solo atrofia (OLGA originale)',
        'max': 'max(atrofia, metaplasia)',
        'combined': 'atrofia+metaplasia combinati'
      };
      
      // Logica follow-up MAPS II con displasia
      let followUpText = '';
      let riskAssessment = '';
      
      if (dysplasia === 2) {
        // HGD
        riskAssessment = 'ALTO RISCHIO - Displasia di alto grado';
        followUpText = `‚ö†Ô∏è GESTIONE CLINICA (MAPS II 2019):
DISPLASIA DI ALTO GRADO (HGD):
‚Üí Staging endoscopico accurato (HD-WLE + cromoscopia)
‚Üí Conferma istologica da secondo patologo esperto
‚Üí Resezione endoscopica di lesioni visibili
‚Üí Se HGD su mucosa piatta: EGDS ogni 6 mesi con mappaggio estensivo
‚Üí Discussione multidisciplinare`;
      } else if (dysplasia === 1) {
        // LGD
        riskAssessment = 'RISCHIO AUMENTATO - Displasia di basso grado';
        followUpText = `‚ö†Ô∏è GESTIONE CLINICA (MAPS II 2019):
DISPLASIA DI BASSO GRADO (LGD):
‚Üí Resezione endoscopica di lesioni visibili
‚Üí Se LGD su mucosa piatta: EGDS ogni 12 mesi con HD-WLE + cromoscopia
‚Üí Eradicazione H. pylori se presente
‚Üí Considerare conferma da patologo esperto`;
      } else if (isHighRisk) {
        // Stadio III-IV senza displasia
        riskAssessment = 'Alto rischio (stadio III-IV) senza displasia';
        followUpText = `‚ö†Ô∏è GESTIONE CLINICA (MAPS II 2019):
STADIO OLGA/OLGIM III-IV:
‚Üí EGDS ogni 3 anni con HD-WLE + cromoscopia
‚Üí Mappaggio bioptico estensivo
‚Üí Eradicazione H. pylori se presente
${miType === 'incomplete' ? '‚Üí MI incompleta: considerare follow-up pi√π ravvicinato' : ''}
${hasDiscordance ? '\n‚ö†Ô∏è NOTA: Discordanza OLGA/OLGIM. Considerare lo stadio pi√π alto.' : ''}`;
      } else {
        // Basso rischio
        riskAssessment = 'Basso rischio (stadi 0-II, no displasia)';
        followUpText = `‚ÑπÔ∏è GESTIONE CLINICA (MAPS II 2019):
STADI OLGA/OLGIM 0-II senza displasia:
‚Üí Non indicata sorveglianza endoscopica routinaria
‚Üí Eradicazione H. pylori se presente
‚Üí Follow-up clinico secondo sintomatologia
${miType === 'incomplete' && hasMetaplasia ? '\n‚ö†Ô∏è NOTA: MI incompleta presente. Valutare clinicamente opportunit√† di follow-up.' : ''}
${hasDiscordance ? '\n‚ö†Ô∏è NOTA: Discordanza OLGA/OLGIM rilevata. Valutare clinicamente.' : ''}`;
      }
      
      // Sezione tipo MI nel referto
      const miTypeSection = hasMetaplasia && miType ? 
        `\nTIPO METAPLASIA INTESTINALE: ${getMITypeText(miType)}` : '';
      
      const report = `REFERTO ISTOLOGICO - GASTRITE CRONICA

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
UPDATED SYDNEY SYSTEM (Dixon et al., 1996)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ANTRO:
  ‚Ä¢ Infiltrato cronico: ${data.antrum.chronic} (${gradeText(data.antrum.chronic)})
  ‚Ä¢ Attivit√† neutrofila: ${data.antrum.activity} (${gradeText(data.antrum.activity)})
  ‚Ä¢ Atrofia ghiandolare: ${data.antrum.atrophy} (${gradeText(data.antrum.atrophy)})
  ‚Ä¢ Metaplasia intestinale: ${data.antrum.metaplasia} (${gradeText(data.antrum.metaplasia)})
  ‚Ä¢ Helicobacter pylori: ${data.antrum.hp} (${gradeText(data.antrum.hp)})

CORPO:
  ‚Ä¢ Infiltrato cronico: ${data.corpus.chronic} (${gradeText(data.corpus.chronic)})
  ‚Ä¢ Attivit√† neutrofila: ${data.corpus.activity} (${gradeText(data.corpus.activity)})
  ‚Ä¢ Atrofia ghiandolare: ${data.corpus.atrophy} (${gradeText(data.corpus.atrophy)})
  ‚Ä¢ Metaplasia intestinale: ${data.corpus.metaplasia} (${gradeText(data.corpus.metaplasia)})
  ‚Ä¢ Helicobacter pylori: ${data.corpus.hp} (${gradeText(data.corpus.hp)})

INCISURA ANGOLARE:
  ‚Ä¢ Infiltrato cronico: ${data.incisura.chronic} (${gradeText(data.incisura.chronic)})
  ‚Ä¢ Attivit√† neutrofila: ${data.incisura.activity} (${gradeText(data.incisura.activity)})
  ‚Ä¢ Atrofia ghiandolare: ${data.incisura.atrophy} (${gradeText(data.incisura.atrophy)})
  ‚Ä¢ Metaplasia intestinale: ${data.incisura.metaplasia} (${gradeText(data.incisura.metaplasia)})
  ‚Ä¢ Helicobacter pylori: ${data.incisura.hp} (${gradeText(data.incisura.hp)})

DISTRIBUZIONE TOPOGRAFICA: Gastrite ${topography}
H. PYLORI: ${hpStatus}
DISPLASIA: ${getDysplasiaText(dysplasia)}${miTypeSection}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
OLGA STAGING SYSTEM (Rugge et al., 2007/2010)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Metodo di calcolo: ${methodDesc[method]}
Nota: Incisura angolare aggregata all'antro (max dei valori)

Score antro (aggregato): ${olgaAntrum}
Score corpo: ${olgaCorpus}

STADIO OLGA: ${olgaStage}
RISCHIO (OLGA): ${olgaRisk.charAt(0).toUpperCase() + olgaRisk.slice(1)} rischio

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
OLGIM STAGING SYSTEM (Capelle et al., 2010)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Basato solo su metaplasia intestinale
Nota: Incisura angolare aggregata all'antro (max dei valori)

Score antro (aggregato): ${olgimAntrum}
Score corpo: ${olgimCorpus}

STADIO OLGIM: ${olgimStage}
RISCHIO (OLGIM): ${olgimRisk.charAt(0).toUpperCase() + olgimRisk.slice(1)} rischio

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
VALUTAZIONE COMPLESSIVA DEL RISCHIO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${riskAssessment}

${followUpText}`;
      
      document.getElementById('reportText').textContent = report;
      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function copyReport() {
      const text = document.getElementById('reportText').textContent;
      if (!text || text === '') {
        showAlert('error', '‚ö†Ô∏è Calcola prima il referto');
        return;
      }
      
      navigator.clipboard.writeText(text)
        .then(() => showAlert('success', '‚úÖ Referto copiato negli appunti'))
        .catch(() => {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showAlert('success', '‚úÖ Referto copiato');
        });
    }
    
    function resetForm() {
      document.querySelectorAll('select').forEach(el => el.value = '');
      document.getElementById('resultsSection').style.display = 'none';
      clearErrors();
      document.getElementById('warningAlert').classList.remove('show');
      document.querySelector('input[name="olga_method"][value="atrophy"]').checked = true;
    }
  </script>
</body>
</html>
