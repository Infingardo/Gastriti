<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gastrite â€“ Sistema di Sydney + OLGA/OLGIM</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #1a202c;
      line-height: 1.6;
    }
    header {
      background: white;
      border-bottom: 2px solid #e2e8f0;
      padding: 1.5rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    h1 { font-size: 1.75rem; font-weight: 700; color: #2d3748; margin-bottom: 0.25rem; }
    .subtitle { font-size: 0.9rem; color: #718096; text-transform: uppercase; letter-spacing: 0.05em; }
    
    .info-panel {
      background: #edf2f7;
      border-left: 4px solid #4299e1;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }
    .info-panel strong { color: #2b6cb0; }
    
    .settings {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .settings label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      margin: 0.5rem 0;
    }
    .settings input[type="radio"] { accent-color: #4299e1; cursor: pointer; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1rem 0; }
    
    .card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card h2 { font-size: 1.1rem; color: #2d3748; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
    .card.global { background: #f0f9ff; border: 2px solid #90cdf4; }
    .card.global h2 { color: #2b6cb0; border-bottom-color: #90cdf4; }
    
    .field { margin-bottom: 1rem; }
    .field label { 
      display: block; 
      font-size: 0.85rem; 
      font-weight: 600; 
      color: #4a5568; 
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .field select {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #cbd5e0;
      border-radius: 0.375rem;
      font-size: 0.95rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .field select:focus { outline: none; border-color: #4299e1; }
    .field select.error { border-color: #f56565; background: #fff5f5; }
    .field select.optional { border-style: dashed; }
    .field small { display: block; color: #718096; font-size: 0.8rem; margin-top: 0.25rem; }
    
    .controls {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    button.primary { background: #4299e1; color: white; }
    button.primary:hover { background: #3182ce; }
    button.secondary { background: #e2e8f0; color: #2d3748; }
    button.secondary:hover { background: #cbd5e0; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .alert {
      padding: 1rem;
      border-radius: 0.375rem;
      margin: 1rem 0;
      display: none;
    }
    .alert.error { background: #fff5f5; border-left: 4px solid #f56565; color: #c53030; }
    .alert.success { background: #f0fff4; border-left: 4px solid #48bb78; color: #22543d; }
    .alert.warning { background: #fffaf0; border-left: 4px solid #ed8936; color: #7c2d12; }
    .alert.show { display: block; }
    
    .results {
      background: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .badges {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .badge.low { background: #c6f6d5; color: #22543d; }
    .badge.high { background: #fed7d7; color: #c53030; }
    .badge.info { background: #bee3f8; color: #2c5282; }
    .badge.warning { background: #feebc8; color: #7c2d12; }
    .badge.dysplasia { background: #e9d8fd; color: #553c9a; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    td { font-size: 0.95rem; }
    
    .report-box {
      background: #f7fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin: 1rem 0;
      white-space: pre-wrap;
      font-family: ui-monospace, monospace;
      font-size: 0.9rem;
      line-height: 1.8;
    }
    
    .footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid #e2e8f0;
      font-size: 0.85rem;
      color: #718096;
    }
    .footer a { color: #4299e1; text-decoration: none; font-weight: 500; }
    .footer a:hover { text-decoration: underline; }
    
    .biblio-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }
    .biblio-item {
      margin: 0.5rem 0;
      padding-left: 1rem;
    }
    
    .matrix-note {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 0.85rem;
    }
    
    @media (max-width: 768px) {
      h1 { font-size: 1.4rem; }
      .subtitle { font-size: 0.85rem; }
      .container { padding: 0.5rem; }
      
      .grid { 
        grid-template-columns: 1fr; 
        gap: 0.75rem; 
      }
      
      .card { 
        padding: 1rem; 
        margin-bottom: 0.75rem;
      }
      .card h2 { font-size: 1rem; }
      
      .field label { font-size: 0.8rem; }
      .field select {
        padding: 0.75rem 0.5rem;
        font-size: 1rem;
      }
      
      button {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
      }
      
      .controls {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .badges {
        flex-direction: column;
        align-items: stretch;
      }
      .badge {
        justify-content: center;
        padding: 0.75rem 1rem;
      }
      
      table {
        font-size: 0.85rem;
      }
      th, td {
        padding: 0.5rem 0.25rem;
      }
      
      .report-box {
        font-size: 0.8rem;
        padding: 1rem;
      }
      
      .info-panel {
        font-size: 0.85rem;
        padding: 0.75rem;
      }
      
      /* Forme speciali su mobile */
      #specialFormsContent > div {
        padding: 0.75rem;
      }
      #specialFormsContent h3 {
        font-size: 0.95rem;
      }
    }
    
    @media (max-width: 480px) {
      h1 { font-size: 1.2rem; }
      .container { padding: 0.25rem; }
      .card { padding: 0.75rem; }
      
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 0.4rem 0.2rem;
      }
      th {
        font-size: 0.7rem;
      }
      
      .report-box {
        font-size: 0.75rem;
      }
    }
    
    @media print {
      header, .controls, .settings, .alert { display: none !important; }
      body { background: white; }
      .card, .results { box-shadow: none; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>ğŸ”¬ Gastrite â€“ Sistema di Sydney + OLGA/OLGIM</h1>
      <div class="subtitle">Tool per refertazione istologica v3.0</div>
    </div>
  </header>
  
  <main class="container">
    <div class="info-panel">
      <strong>Scala Sydney:</strong> 0 = assente Â· 1 = lieve Â· 2 = moderata Â· 3 = severa<br>
      <strong>Nota:</strong> L'incisura angolare viene aggregata all'antro per il calcolo OLGA/OLGIM (max tra i due valori)
    </div>
    
    <div class="info-panel" style="border-left-color: #e53e3e; background: #fff5f5;">
      <strong>âš ï¸ Avvertenza medico-legale:</strong> Tool di supporto alla refertazione istologica. 
      Non sostituisce il giudizio diagnostico e la responsabilitÃ  del patologo refertante. 
      Tutti i dati devono essere validati clinicamente prima dell'uso.
    </div>
    
    <div class="settings">
      <strong style="display: block; margin-bottom: 0.5rem;">Metodo di calcolo OLGA:</strong>
      <label>
        <input type="radio" name="olga_method" value="atrophy" checked>
        Solo atrofia ghiandolare (approccio conservativo, OLGA originale)
      </label>
      <label>
        <input type="radio" name="olga_method" value="max">
        Massimo tra atrofia e metaplasia per sede (piÃ¹ sensibile)
      </label>
      <label>
        <input type="radio" name="olga_method" value="combined">
        Atrofia + Metaplasia combinati (se atrofia â‰¥1 OR metaplasia â‰¥1)
      </label>
      
      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="brief_report" style="accent-color: #4299e1;">
          <span><strong>Referto breve</strong> (essenziale per LIS/endoscopisti)</span>
        </label>
        <small style="display: block; margin-top: 0.25rem; color: #718096;">
          Solo diagnosi, stadi e follow-up. Disattiva per referto esteso completo.
        </small>
      </div>
    </div>
    
    <div id="errorAlert" class="alert error"></div>
    <div id="successAlert" class="alert success"></div>
    <div id="warningAlert" class="alert warning"></div>
    
    <!-- Card globale per displasia e tipo MI -->
    <div class="card global">
      <h2>Valutazione globale</h2>
      <div class="grid" style="margin: 0;">
        <div class="field">
          <label>Displasia</label>
          <select id="dysplasia">
            <option value="">â€”</option>
            <option value="0">Assente</option>
            <option value="1">Basso grado (LGD)</option>
            <option value="2">Alto grado (HGD)</option>
          </select>
          <small>Campo obbligatorio per stratificazione rischio MAPS II</small>
        </div>
        <div class="field">
          <label>Tipo metaplasia intestinale</label>
          <select id="mi_type" class="optional">
            <option value="">Non valutato</option>
            <option value="absent">Assente</option>
            <option value="complete">Completa (tipo I)</option>
            <option value="incomplete">Incompleta (tipo II/III)</option>
            <option value="mixed">Mista</option>
          </select>
          <small>Se "Assente" â†’ tutti i campi metaplasia vengono settati a 0 automaticamente</small>
        </div>
      </div>
    </div>
    
    <!-- Quick Fill Shortcuts -->
    <div class="card" style="background: #f0f9ff; border: 2px solid #3b82f6;">
      <h2 style="color: #1e40af; border-bottom-color: #93c5fd;">âš¡ Compilazione rapida</h2>
      <div style="display: grid; gap: 1rem; margin-top: 1rem;">
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <button class="secondary" style="flex: 1; min-width: 180px;" onclick="setNegativeCase()">
            âœ… Tutto negativo
          </button>
          <button class="secondary" style="flex: 1; min-width: 180px;" onclick="setHPyCase()">
            ğŸ¦  H. pylori+ lieve
          </button>
          <button class="secondary" style="flex: 1; min-width: 180px;" onclick="setAllMetaplasiaZero()">
            ğŸš« Metaplasia assente
          </button>
        </div>
        <small style="color: #1e40af;">
          <strong>Shortcut:</strong> Casi comuni precompilati. TIP: usa il menu "Tipo MI" sopra per selezionare "Assente"!
        </small>
      </div>
    </div>
    
    <div class="grid">
      <div class="card">
        <h2>Antro</h2>
        <div class="field">
          <label>Infiltrato cronico</label>
          <select id="an_chronic">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
        <div class="field">
          <label>AttivitÃ  (neutrofili)</label>
          <select id="an_activity">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Atrofia ghiandolare</label>
          <select id="an_atrophy">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Metaplasia intestinale</label>
          <select id="an_metaplasia">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Helicobacter pylori</label>
          <select id="an_hp">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <h2>Incisura angolare</h2>
        <div class="field">
          <label>Infiltrato cronico</label>
          <select id="in_chronic">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
        <div class="field">
          <label>AttivitÃ  (neutrofili)</label>
          <select id="in_activity">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Atrofia ghiandolare</label>
          <select id="in_atrophy">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Metaplasia intestinale</label>
          <select id="in_metaplasia">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Helicobacter pylori</label>
          <select id="in_hp">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <h2>Corpo</h2>
        <div class="field">
          <label>Infiltrato cronico</label>
          <select id="co_chronic">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
        <div class="field">
          <label>AttivitÃ  (neutrofili)</label>
          <select id="co_activity">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Atrofia ghiandolare</label>
          <select id="co_atrophy">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Metaplasia intestinale</label>
          <select id="co_metaplasia">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderata</option>
            <option value="3">3 - Severa</option>
          </select>
        </div>
        <div class="field">
          <label>Helicobacter pylori</label>
          <select id="co_hp">
            <option value="">â€”</option>
            <option value="0">0 - Assente</option>
            <option value="1">1 - Lieve</option>
            <option value="2">2 - Moderato</option>
            <option value="3">3 - Severo</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Sezione Forme Speciali -->
    <div class="card" style="border: 2px solid #d69e2e; background: #fffbeb;">
      <h2 style="color: #744210; border-bottom-color: #f6ad55; cursor: pointer; user-select: none;" onclick="toggleSpecialForms()">
        âš ï¸ Forme Speciali di Gastrite 
        <span id="specialFormsToggle" style="float: right; font-size: 1.2rem;">â–¼</span>
      </h2>
      <div id="specialFormsContent" style="display: none; margin-top: 1rem;">
        <div class="info-panel" style="background: #fef3c7; border-left-color: #d97706;">
          <strong>Nota:</strong> Valutare solo se il pattern istologico suggerisce una forma speciale. 
          Il sistema genererÃ  alert se i criteri sono incompatibili con H. pylori-associata.
        </div>
        
        <!-- Chemical/Reactive Gastritis -->
        <div style="margin: 1.5rem 0; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
          <h3 style="font-size: 1rem; color: #2d3748; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">
            ğŸ§ª Gastropatia Chimica / Reattiva
          </h3>
          <div style="display: grid; gap: 1rem;">
            <div class="field">
              <label>Iperplasia foveolare</label>
              <select id="foveolar_hyperplasia">
                <option value="">â€”</option>
                <option value="0">0 - Assente</option>
                <option value="1">1 - Lieve</option>
                <option value="2">2 - Moderata</option>
                <option value="3">3 - Marcata</option>
              </select>
            </div>
            <div class="field">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none; letter-spacing: normal; font-weight: normal;">
                <input type="checkbox" id="lamina_edema" style="accent-color: #4299e1;">
                <span>Edema della lamina propria</span>
              </label>
            </div>
            <div class="field">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none; letter-spacing: normal; font-weight: normal;">
                <input type="checkbox" id="smooth_muscle_prolif" style="accent-color: #4299e1;">
                <span>Proliferazione muscolo liscio nella lamina propria</span>
              </label>
            </div>
            <div style="font-size: 0.85rem; color: #718096;">
              <strong>Eziologie comuni:</strong> Reflusso biliare (post-gastrectomia), FANS, alcol
            </div>
          </div>
        </div>
        
        <!-- Autoimmune Gastritis -->
        <div style="margin: 1.5rem 0; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
          <h3 style="font-size: 1rem; color: #2d3748; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">
            ğŸ¯ Gastrite Autoimmune (tipo A)
          </h3>
          <div style="display: grid; gap: 1rem;">
            <div class="field">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none; letter-spacing: normal; font-weight: normal;">
                <input type="checkbox" id="corpus_restricted" style="accent-color: #4299e1;">
                <span>Pattern corpo-predominante/ristretto (corpo >>> antro)</span>
              </label>
            </div>
            <div class="field">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none; letter-spacing: normal; font-weight: normal;">
                <input type="checkbox" id="pseudopyloric_meta" style="accent-color: #4299e1;">
                <span>Metaplasia pseudopilorica (vs. metaplasia intestinale)</span>
              </label>
            </div>
            <div class="field">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none; letter-spacing: normal; font-weight: normal;">
                <input type="checkbox" id="ecl_hyperplasia" style="accent-color: #4299e1;">
                <span>Iperplasia cellule ECL (argirofilia/cromogranina)</span>
              </label>
            </div>
            <div style="font-size: 0.85rem; color: #718096;">
              <strong>Associazioni:</strong> Anemia perniciosa, ipergastrinemia, anticorpi anti-cellule parietali
            </div>
          </div>
        </div>
        
        <!-- Lymphocytic Gastritis -->
        <div style="margin: 1.5rem 0; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
          <h3 style="font-size: 1rem; color: #2d3748; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">
            ğŸ”¬ Gastrite Linfocitaria
          </h3>
          <div style="display: grid; gap: 1rem;">
            <div class="field">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none; letter-spacing: normal; font-weight: normal;">
                <input type="checkbox" id="high_iels" style="accent-color: #4299e1;">
                <span>Linfociti intraepiteliali aumentati (â‰¥20â€“25 per 100 cellule epiteliali)</span>
              </label>
            </div>
            <div style="font-size: 0.85rem; color: #718096;">
              <strong>Associazioni:</strong> Gastrite variolariforme (endoscopia), malattia celiaca (20-40% dei casi), MÃ©nÃ©trier's disease
            </div>
          </div>
        </div>
        
        <!-- Eosinophilic Gastritis -->
        <div style="margin: 1.5rem 0; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
          <h3 style="font-size: 1rem; color: #2d3748; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">
            ğŸ”´ Gastrite Eosinofila
          </h3>
          <div style="display: grid; gap: 1rem;">
            <div class="field">
              <label>Eosinofili per campo ad alto ingrandimento (HPF)</label>
              <select id="eosinophils_hpf">
                <option value="">Non valutato</option>
                <option value="0">&lt;10 eosinofili/HPF (entro limiti)</option>
                <option value="1">10-19 eosinofili/HPF (lievemente aumentati)</option>
                <option value="2">20-29 eosinofili/HPF (moderatamente aumentati)</option>
                <option value="3">â‰¥30 eosinofili/HPF (marcatamente aumentati)</option>
              </select>
              <small>Soglia diagnostica: â‰¥30 eosinofili/HPF (Rosai and Ackerman's, 11th ed.)</small>
            </div>
            <div style="font-size: 0.85rem; color: #718096;">
              <strong>DD essenziali:</strong> Parassitosi (Anisakis), farmaci (PPI, FANS), IBD, vasculiti, neoplasie (linfoma, carcinoma)
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Note libere -->
    <div class="card" style="border: 2px solid #718096; background: #f7fafc;">
      <h2 style="color: #2d3748; border-bottom-color: #cbd5e0;">
        ğŸ“ Note aggiuntive
      </h2>
      <div class="field" style="margin-top: 1rem;">
        <label>Osservazioni libere (opzionale)</label>
        <textarea id="free_notes" rows="4" style="width: 100%; padding: 0.75rem; border: 2px solid #cbd5e0; border-radius: 0.375rem; font-size: 0.95rem; font-family: inherit; resize: vertical;" placeholder="Eventuali osservazioni aggiuntive non coperte dai campi strutturati (es: aspetti morfologici particolari, note cliniche, dubbi diagnostici...)"></textarea>
        <small>Queste note verranno aggiunte alla fine del referto se compilate.</small>
      </div>
    </div>
    
    <div class="controls">
      <button class="primary" onclick="calculate()">ğŸ“Š Calcola referto</button>
      <button class="secondary" onclick="copyReport()">ğŸ“‹ Copia referto</button>
      <button class="secondary" onclick="window.print()">ğŸ–¨ï¸ Stampa/PDF</button>
      <button class="secondary" onclick="resetForm()">ğŸ”„ Reset</button>
    </div>
    
    <div id="resultsSection" class="results" style="display: none;">
      <h2 style="margin-bottom: 1rem;">Risultati</h2>
      
      <div id="badgesContainer" class="badges"></div>
      
      <table>
        <thead>
          <tr>
            <th>Sede</th>
            <th>Infiltr. cronico</th>
            <th>AttivitÃ </th>
            <th>Atrofia</th>
            <th>Metaplasia</th>
            <th>H. pylori</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      
      <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Referto istologico</h3>
      <div id="reportText" class="report-box"></div>
      
      <div class="footer">
        <p><strong>âš ï¸ Nota clinica:</strong> Gli stadi OLGA/OLGIM stratificano il rischio di adenocarcinoma gastrico. Stadi III-IV richiedono sorveglianza endoscopica secondo linee guida MAPS II (ESGE/ESP 2019). La presenza di displasia modifica significativamente il management.</p>
        
        <div class="biblio-section">
          <strong>Riferimenti bibliografici:</strong>
          <div class="biblio-item">
            â€¢ Dixon MF et al. Classification and grading of gastritis. The updated Sydney System. 
            <em>Am J Surg Pathol</em> 1996;20(10):1161-81. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/8827022/" target="_blank" rel="noopener">PMID:8827022</a>
          </div>
          <div class="biblio-item">
            â€¢ Rugge M et al. Gastritis staging in clinical practice: the OLGA staging system. 
            <em>Gut</em> 2007;56(5):631-6. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/17142647/" target="_blank" rel="noopener">PMID:17142647</a>
          </div>
          <div class="biblio-item">
            â€¢ Rugge M et al. OLGA gastritis staging for the assessment of gastric cancer risk: a twelve-year clinico-pathological follow-up study. 
            <em>Dig Liver Dis</em> 2010;42(3):177-82. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/19793674/" target="_blank" rel="noopener">PMID:19793674</a>
          </div>
          <div class="biblio-item">
            â€¢ Capelle LG et al. The staging of gastritis with the OLGA system by using intestinal metaplasia as an accurate alternative for atrophic gastritis. 
            <em>Gastrointest Endosc</em> 2010;71(7):1150-8. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/20381801/" target="_blank" rel="noopener">PMID:20381801</a>
          </div>
          <div class="biblio-item">
            â€¢ Capelle LG et al. Staging gastritis with the OLGIM: a less complex alternative to OLGA gastritis staging. 
            <em>Am J Surg Pathol</em> 2010;34(11):1653-64. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/20975341/" target="_blank" rel="noopener">PMID:20975341</a>
          </div>
          <div class="biblio-item">
            â€¢ Pimentel-Nunes P et al. Management of epithelial precancerous conditions and lesions in the stomach (MAPS II): European Society of Gastrointestinal Endoscopy, European Helicobacter and Microbiota Study Group, European Society of Pathology, and Sociedade Portuguesa de Endoscopia Digestiva Guideline Update 2019. 
            <em>Endoscopy</em> 2019;51(4):365-388. 
            <a href="https://pubmed.ncbi.nlm.nih.gov/30841008/" target="_blank" rel="noopener">PMID:30841008</a>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    // Matrice OLGA originale (Rugge et al. 2007)
    // Righe: corpo (0-3), Colonne: antro (0-3)
    const OLGA_MATRIX = [
      ['0',  'I',   'II',  'II' ],  // corpo 0
      ['I',  'I',   'II',  'III'],  // corpo 1
      ['II', 'II',  'III', 'IV' ],  // corpo 2
      ['II', 'III', 'IV',  'IV' ]   // corpo 3
    ];
    
    function getValue(id) {
      const el = document.getElementById(id);
      return el && el.value !== '' ? parseInt(el.value, 10) : null;
    }
    
    function getStringValue(id) {
      const el = document.getElementById(id);
      return el ? el.value : '';
    }
    
    function showAlert(type, message) {
      const alertId = type === 'error' ? 'errorAlert' : type === 'warning' ? 'warningAlert' : 'successAlert';
      const alert = document.getElementById(alertId);
      alert.textContent = message;
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 6000);
    }
    
    function clearErrors() {
      document.querySelectorAll('select.error').forEach(el => el.classList.remove('error'));
      document.getElementById('errorAlert').classList.remove('show');
      document.getElementById('warningAlert').classList.remove('show');
    }
    
    function toggleSpecialForms() {
      const content = document.getElementById('specialFormsContent');
      const toggle = document.getElementById('specialFormsToggle');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = 'â–²';
      } else {
        content.style.display = 'none';
        toggle.textContent = 'â–¼';
      }
    }
    
    function validate() {
      clearErrors();
      const fields = [
        'an_chronic', 'an_activity', 'an_atrophy', 'an_metaplasia', 'an_hp',
        'co_chronic', 'co_activity', 'co_atrophy', 'co_metaplasia', 'co_hp',
        'in_chronic', 'in_activity', 'in_atrophy', 'in_metaplasia', 'in_hp',
        'dysplasia'
      ];
      
      const missing = fields.filter(id => getValue(id) === null);
      
      if (missing.length > 0) {
        missing.forEach(id => document.getElementById(id).classList.add('error'));
        showAlert('error', `âš ï¸ Compila tutti i campi obbligatori (${missing.length} mancanti)`);
        return false;
      }
      return true;
    }
    
    function getOLGAScore(atrophy, metaplasia, method) {
      if (method === 'atrophy') return atrophy;
      if (method === 'max') return Math.max(atrophy, metaplasia);
      if (method === 'combined') {
        return (atrophy >= 1 || metaplasia >= 1) ? Math.max(atrophy, metaplasia) : 0;
      }
      return atrophy;
    }
    
    // Calcolo stadio usando la matrice OLGA corretta
    function calculateStage(antrumScore, corpusScore) {
      // Clamp dei valori a 0-3
      const a = Math.min(3, Math.max(0, antrumScore));
      const c = Math.min(3, Math.max(0, corpusScore));
      return OLGA_MATRIX[c][a];
    }
    
    function getTopography(anChronic, coChronic) {
      // Topografia basata solo su infiltrato cronico (piÃ¹ appropriato clinicamente)
      if (anChronic <= 1 && coChronic <= 1) return 'gastrite cronica con infiltrato di grado minimo';
      const diff = anChronic - coChronic;
      if (Math.abs(diff) <= 1) return 'Gastrite diffusa (pangastrite)';
      return diff > 0 ? 'Gastrite prevalentemente antrale' : 'Gastrite prevalentemente corpale';
    }
    
    function gradeText(val) {
      const words = ['assente', 'lieve', 'moderata', 'severa'];
      return words[val] || '?';
    }
    
    function getRiskLevel(stage) {
      if (stage === 'III' || stage === 'IV') return 'alto';
      if (stage === '0' || stage === 'I' || stage === 'II') return 'basso';
      return 'indeterminato';
    }
    
    function getDysplasiaText(val) {
      if (val === 0) return 'Assente';
      if (val === 1) return 'Basso grado (LGD)';
      if (val === 2) return 'Alto grado (HGD)';
      return '?';
    }
    
    function getMITypeText(val) {
      if (val === 'complete') return 'Completa (tipo I)';
      if (val === 'incomplete') return 'Incompleta (tipo II/III)';
      if (val === 'mixed') return 'Mista (completa + incompleta)';
      if (val === 'absent') return 'Assente';
      return 'Non valutato';
    }
    
    function calculate() {
      if (!validate()) return;
      
      const method = document.querySelector('input[name="olga_method"]:checked').value;
      const dysplasia = getValue('dysplasia');
      const miType = getStringValue('mi_type');
      
      const data = {
        antrum: {
          chronic: getValue('an_chronic'),
          activity: getValue('an_activity'),
          atrophy: getValue('an_atrophy'),
          metaplasia: getValue('an_metaplasia'),
          hp: getValue('an_hp')
        },
        corpus: {
          chronic: getValue('co_chronic'),
          activity: getValue('co_activity'),
          atrophy: getValue('co_atrophy'),
          metaplasia: getValue('co_metaplasia'),
          hp: getValue('co_hp')
        },
        incisura: {
          chronic: getValue('in_chronic'),
          activity: getValue('in_activity'),
          atrophy: getValue('in_atrophy'),
          metaplasia: getValue('in_metaplasia'),
          hp: getValue('in_hp')
        }
      };
      
      // Raccolta dati forme speciali (con controlli sicuri)
      const getChecked = (id) => {
        const el = document.getElementById(id);
        return el ? el.checked : false;
      };
      
      const specialForms = {
        chemical: {
          foveolarHyperplasia: getValue('foveolar_hyperplasia'),
          laminaEdema: getChecked('lamina_edema'),
          smoothMuscleProlif: getChecked('smooth_muscle_prolif')
        },
        autoimmune: {
          corpusRestricted: getChecked('corpus_restricted'),
          pseudopyloricMeta: getChecked('pseudopyloric_meta'),
          eclHyperplasia: getChecked('ecl_hyperplasia')
        },
        lymphocytic: {
          highIELs: getChecked('high_iels')
        },
        eosinophilic: {
          eosinophilsHPF: getValue('eosinophils_hpf')
        }
      };
      
      // Verifica forme speciali attive
      const hasChemical = specialForms.chemical.foveolarHyperplasia !== null || 
                         specialForms.chemical.laminaEdema || 
                         specialForms.chemical.smoothMuscleProlif;
      const hasAutoimmune = specialForms.autoimmune.corpusRestricted || 
                           specialForms.autoimmune.pseudopyloricMeta || 
                           specialForms.autoimmune.eclHyperplasia;
      const hasLymphocytic = specialForms.lymphocytic.highIELs;
      const hasEosinophilic = specialForms.eosinophilic.eosinophilsHPF !== null;
      
      // Alert per incompatibilitÃ  forme speciali
      const maxActivity = Math.max(data.antrum.activity, data.corpus.activity, data.incisura.activity);
      const maxChronic = Math.max(data.antrum.chronic, data.corpus.chronic, data.incisura.chronic);
      const hpMax = Math.max(data.antrum.hp, data.corpus.hp, data.incisura.hp);
      
      // Chemical: incompatibile con alta attivitÃ  neutrofila
      if (hasChemical && maxActivity > 1) {
        showAlert('warning', 'âš ï¸ ALERT: Gastropatia chimica Ã¨ tipicamente paucicellulare. AttivitÃ  neutrofila >1 Ã¨ inconsueta (verificare H. pylori).');
      }
      
      // Chemical: alert ROSAI - pattern paucicellulare
      if (hasChemical && maxChronic <= 1) {
        showAlert('success', 'âœ… PATTERN COMPATIBILE: Gastropatia chimica con scarso infiltrato infiammatorio (score â‰¤1). Iperplasia foveolare e congestione capillare in assenza di significativo infiltrato flogistico.');
      }
      
      // Eosinophilic: soglia critica â‰¥30/HPF
      if (hasEosinophilic && specialForms.eosinophilic.eosinophilsHPF === 3) {
        showAlert('warning', 'âš ï¸ GASTRITE EOSINOFILA: Infiltrato eosinofilo â‰¥30/HPF eccedente soglia critica. DD: parassitosi (Anisakis), farmaci (PPI, FANS), IBD, vasculiti, neoplasie. Consigliata valutazione clinica approfondita.');
      }
      
      // Autoimmune: pattern incompatibile con corpus-restricted
      if (hasAutoimmune) {
        const corpusInflammation = data.corpus.chronic;
        const antrumInflammation = Math.max(data.antrum.chronic, data.incisura.chronic);
        if (!specialForms.autoimmune.corpusRestricted && (corpusInflammation <= antrumInflammation)) {
          showAlert('warning', 'âš ï¸ ALERT: Criteri autoimmuni presenti ma pattern non corpo-predominante. Verificare distribuzione.');
        }
        if (hpMax > 1) {
          showAlert('warning', 'âš ï¸ ALERT: H. pylori abbondante Ã¨ raro in gastrite autoimmune conclamata.');
        }
      }
      
      // VALIDAZIONI INCROCIATE CLINICHE
      // AttivitÃ  neutrofila senza H. pylori
      if (maxActivity > 0 && hpMax === 0) {
        showAlert('warning', 'âš ï¸ VALIDAZIONE: AttivitÃ  neutrofila presente senza H. pylori rilevabile. Considerare: altri patogeni, forme speciali, artefatti.');
      }
      
      // Metaplasia senza atrofia (pattern insolito)
      const hasMetaplasiaWithoutAtrophy = (data.antrum.metaplasia > 0 && data.antrum.atrophy === 0) ||
                                          (data.corpus.metaplasia > 0 && data.corpus.atrophy === 0) ||
                                          (data.incisura.metaplasia > 0 && data.incisura.atrophy === 0);
      if (hasMetaplasiaWithoutAtrophy) {
        showAlert('warning', 'âš ï¸ VALIDAZIONE: Metaplasia intestinale senza atrofia ghiandolare Ã¨ insolita. Verificare campionamento.');
      }
      
      // Atrofia/metaplasia marcata senza infiltrato cronico significativo
      const hasAtrophyWithoutInflammation = (data.antrum.atrophy >= 2 && data.antrum.chronic < 2) ||
                                            (data.corpus.atrophy >= 2 && data.corpus.chronic < 2);
      if (hasAtrophyWithoutInflammation) {
        showAlert('warning', 'âš ï¸ VALIDAZIONE: Atrofia marcata con scarso infiltrato cronico. Pattern suggestivo di gastrite autoimmune avanzata o post-eradicazione.');
      }
      
      // Aggregazione incisura all'antro: prendi il max tra antro e incisura
      const antrumAtrophyAggregated = Math.max(data.antrum.atrophy, data.incisura.atrophy);
      const antrumMetaplasiaAggregated = Math.max(data.antrum.metaplasia, data.incisura.metaplasia);
      
      // OLGA scores per sede (con incisura aggregata all'antro)
      const olgaAntrum = getOLGAScore(antrumAtrophyAggregated, antrumMetaplasiaAggregated, method);
      const olgaCorpus = getOLGAScore(data.corpus.atrophy, data.corpus.metaplasia, method);
      const olgaStage = calculateStage(olgaAntrum, olgaCorpus);
      
      // OLGIM scores (solo metaplasia intestinale, con incisura aggregata)
      const olgimAntrum = antrumMetaplasiaAggregated;
      const olgimCorpus = data.corpus.metaplasia;
      const olgimStage = calculateStage(olgimAntrum, olgimCorpus);
      
      // Topografia basata su infiltrato cronico
      const maxAntrumChronic = Math.max(data.antrum.chronic, data.incisura.chronic);
      const topography = getTopography(maxAntrumChronic, data.corpus.chronic);
      
      const olgaRisk = getRiskLevel(olgaStage);
      const olgimRisk = getRiskLevel(olgimStage);
      const isHighRisk = olgaRisk === 'alto' || olgimRisk === 'alto';
      
      // Calcola discordanza tra OLGA e OLGIM
      const stageValues = { '0': 0, 'I': 1, 'II': 2, 'III': 3, 'IV': 4 };
      const stageDiff = Math.abs(stageValues[olgaStage] - stageValues[olgimStage]);
      const hasDiscordance = stageDiff >= 2;
      
      // Verifica se c'Ã¨ metaplasia in qualche sede
      const hasMetaplasia = antrumMetaplasiaAggregated > 0 || data.corpus.metaplasia > 0;
      
      // Badges
      const olgaBadgeClass = olgaRisk === 'alto' ? 'high' : 'low';
      const olgimBadgeClass = olgimRisk === 'alto' ? 'high' : 'low';
      
      let badgesHTML = `
        <span class="badge ${olgaBadgeClass}">
          <span class="dot" style="background: ${olgaRisk === 'alto' ? '#f56565' : '#48bb78'}"></span>
          OLGA ${olgaStage}
        </span>
        <span class="badge ${olgimBadgeClass}">
          <span class="dot" style="background: ${olgimRisk === 'alto' ? '#f56565' : '#48bb78'}"></span>
          OLGIM ${olgimStage}
        </span>
        <span class="badge info">
          <span class="dot" style="background: #4299e1"></span>
          ${topography}
        </span>
      `;
      
      if (dysplasia > 0) {
        const dysplasiaBadgeClass = dysplasia === 2 ? 'high' : 'dysplasia';
        badgesHTML += `
          <span class="badge ${dysplasiaBadgeClass}">
            <span class="dot" style="background: ${dysplasia === 2 ? '#f56565' : '#805ad5'}"></span>
            Displasia ${dysplasia === 1 ? 'LGD' : 'HGD'}
          </span>
        `;
      }
      
      if (hasDiscordance) {
        badgesHTML += `
          <span class="badge warning">
            <span class="dot" style="background: #ed8936"></span>
            Discordanza OLGA/OLGIM
          </span>
        `;
        showAlert('warning', 'âš ï¸ OLGA e OLGIM divergono â‰¥2 stadi: considerare lo stadio piÃ¹ alto per la sorveglianza');
      }
      
      // Badge forme speciali
      if (hasChemical) {
        badgesHTML += `
          <span class="badge warning">
            <span class="dot" style="background: #f59e0b"></span>
            Gastropatia chimica/reattiva
          </span>
        `;
      }
      if (hasAutoimmune) {
        badgesHTML += `
          <span class="badge info">
            <span class="dot" style="background: #8b5cf6"></span>
            Pattern autoimmune
          </span>
        `;
      }
      if (hasLymphocytic) {
        badgesHTML += `
          <span class="badge dysplasia">
            <span class="dot" style="background: #6366f1"></span>
            Gastrite linfocitaria
          </span>
        `;
      }
      if (hasEosinophilic) {
        badgesHTML += `
          <span class="badge ${specialForms.eosinophilic.eosinophilsHPF === 3 ? 'high' : 'warning'}">
            <span class="dot" style="background: ${specialForms.eosinophilic.eosinophilsHPF === 3 ? '#ef4444' : '#f59e0b'}"></span>
            Gastrite eosinofila ${specialForms.eosinophilic.eosinophilsHPF === 3 ? '(â‰¥30/HPF)' : ''}
          </span>
        `;
      }
      
      document.getElementById('badgesContainer').innerHTML = badgesHTML;
      
      // Tabella
      const sites = [
        ['Antro', data.antrum],
        ['Incisura', data.incisura],
        ['Corpo', data.corpus]
      ];
      
      document.getElementById('tableBody').innerHTML = sites.map(([name, d]) => `
        <tr>
          <td><strong>${name}</strong></td>
          <td>${d.chronic}</td>
          <td>${d.activity}</td>
          <td>${d.atrophy}</td>
          <td>${d.metaplasia}</td>
          <td>${d.hp}</td>
        </tr>
      `).join('');
      
      // Referto
      const hpStatus = hpMax > 0 ? 
        `Presenza di Helicobacter pylori (grado ${hpMax})` : 
        'Assenza di Helicobacter pylori';
      
      const methodDesc = {
        'atrophy': 'solo atrofia (OLGA originale)',
        'max': 'max(atrofia, metaplasia)',
        'combined': 'atrofia+metaplasia combinati'
      };
      
      // Logica follow-up MAPS II con displasia
      let followUpText = '';
      let riskAssessment = '';
      
      if (dysplasia === 2) {
        // HGD
        riskAssessment = 'ALTO RISCHIO - Displasia alto grado';
        followUpText = `DISPLASIA ALTO GRADO (HGD):
Staging HD-WLE+cromoscopia | Conferma 2Â° patologo | Resezione lesioni visibili
Se HGD piatta: EGDS ogni 6 mesi con mappaggio estensivo | Discussione MDT`;
      } else if (dysplasia === 1) {
        // LGD
        riskAssessment = 'RISCHIO AUMENTATO - Displasia basso grado';
        followUpText = `DISPLASIA BASSO GRADO (LGD):
Resezione lesioni visibili | EGDS ogni 12 mesi (HD-WLE+cromoscopia) | Eradicazione HP`;
      } else if (isHighRisk) {
        // Stadio III-IV senza displasia
        riskAssessment = 'Alto rischio (stadio III-IV) no displasia';
        followUpText = `STADIO III-IV:
EGDS ogni 3 anni (HD-WLE+cromoscopia) | Mappaggio bioptico estensivo | Eradicazione HP${miType === 'incomplete' ? ' | MI incompleta: F/U ravvicinato' : ''}${hasDiscordance ? '\nâš ï¸ Discordanza OLGA/OLGIM â†’ considerare stadio piÃ¹ alto' : ''}`;
      } else {
        // Basso rischio
        riskAssessment = 'Basso rischio (stadi 0-II) no displasia';
        followUpText = `STADI 0-II:
No sorveglianza routinaria | Eradicazione HP | Follow-up clinico${miType === 'incomplete' && hasMetaplasia ? ' | MI incompleta: valutare F/U' : ''}${hasDiscordance ? '\nâš ï¸ Discordanza OLGA/OLGIM rilevata' : ''}`;
      }
      
      // Sezione tipo MI nel referto (non mostrare se "absent" perchÃ© ridondante)
      // Sezione tipo MI nel referto
      let miTypeSection = '';
      if (miType === 'absent') {
        // Esplicito "Assente" solo nel referto esteso per chiarezza
        miTypeSection = '\nMETAPLASIA INTESTINALE: Assente';
      } else if (hasMetaplasia && miType) {
        miTypeSection = `\nTIPO METAPLASIA INTESTINALE: ${getMITypeText(miType)}`;
      }
      
      // Note libere
      const freeNotesEl = document.getElementById('free_notes');
      const freeNotes = freeNotesEl ? freeNotesEl.value.trim() : '';
      const freeNotesSection = freeNotes ? 
        `\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nNOTE AGGIUNTIVE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${freeNotes}` : '';
      
      // Check modalitÃ  referto breve
      const briefReportEl = document.getElementById('brief_report');
      const isBriefMode = briefReportEl ? briefReportEl.checked : false;
      
      let report;
      
      if (isBriefMode) {
        // REFERTO BREVE per LIS/Endoscopisti
        const briefFollowUp = dysplasia === 2 ? 'HGD: resezione endoscopica + staging accurato' :
                              dysplasia === 1 ? 'LGD: EGDS ogni 12 mesi + resezione lesioni' :
                              isHighRisk ? `Stadio III-IV: EGDS ogni ${olgaStage === 'IV' || olgimStage === 'IV' ? '1-2' : '3'} anni` :
                              'Stadi 0-II: non indicata sorveglianza routinaria';
        
        const specialFormsText = (hasChemical || hasAutoimmune || hasLymphocytic) ? 
          `\n${hasChemical ? 'â€¢ Pattern reattivo/chimico' : ''}${hasAutoimmune ? 'â€¢ Pattern autoimmune' : ''}${hasLymphocytic ? 'â€¢ Gastrite linfocitaria' : ''}` : '';
        
        report = `REFERTO ISTOLOGICO - GASTRITE CRONICA

DIAGNOSI: ${topography}
(Pattern basato sull'infiltrato cronico)

H. PYLORI: ${hpMax > 0 ? `Presente (grado ${hpMax}) â€“ raccomandata eradicazione` : 'Assente'}

DISPLASIA: ${getDysplasiaText(dysplasia)}${miTypeSection}${specialFormsText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
STAGING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

OLGA: stadio ${olgaStage} (${olgaRisk} rischio)
OLGIM: stadio ${olgimStage} (${olgimRisk} rischio)
${hasDiscordance ? '\nâš ï¸ NOTA CRITICA: Discordanza OLGA/OLGIM â‰¥2 stadi â†’ considerare lo stadio piÃ¹ alto' : ''}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
FOLLOW-UP (MAPS II - ESGE/ESP 2019)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${briefFollowUp}
${hpMax > 0 ? 'â€¢ Eradicazione H. pylori' : ''}
${miType === 'incomplete' ? 'â€¢ MI incompleta: follow-up piÃ¹ ravvicinato' : ''}${freeNotesSection}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Referto generato con tool Sydney-OLGA/OLGIM v3.0 (MAPS II - ESGE/ESP 2019)
SC Anatomia Patologica, ASST Fatebenefratelli-Sacco, Milano`;
        
      } else {
        // REFERTO ESTESO COMPATTO
        report = `REFERTO ISTOLOGICO - GASTRITE CRONICA

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
UPDATED SYDNEY SYSTEM (Dixon et al., 1996)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Sede        Inf.Cr  Attiv  Atrof  Metap  H.p
Antro         ${data.antrum.chronic}(${gradeText(data.antrum.chronic).substring(0,3)})   ${data.antrum.activity}(${gradeText(data.antrum.activity).substring(0,3)})  ${data.antrum.atrophy}(${gradeText(data.antrum.atrophy).substring(0,3)})  ${data.antrum.metaplasia}(${gradeText(data.antrum.metaplasia).substring(0,3)})  ${data.antrum.hp}(${gradeText(data.antrum.hp).substring(0,3)})
Incisura      ${data.incisura.chronic}(${gradeText(data.incisura.chronic).substring(0,3)})   ${data.incisura.activity}(${gradeText(data.incisura.activity).substring(0,3)})  ${data.incisura.atrophy}(${gradeText(data.incisura.atrophy).substring(0,3)})  ${data.incisura.metaplasia}(${gradeText(data.incisura.metaplasia).substring(0,3)})  ${data.incisura.hp}(${gradeText(data.incisura.hp).substring(0,3)})
Corpo         ${data.corpus.chronic}(${gradeText(data.corpus.chronic).substring(0,3)})   ${data.corpus.activity}(${gradeText(data.corpus.activity).substring(0,3)})  ${data.corpus.atrophy}(${gradeText(data.corpus.atrophy).substring(0,3)})  ${data.corpus.metaplasia}(${gradeText(data.corpus.metaplasia).substring(0,3)})  ${data.corpus.hp}(${gradeText(data.corpus.hp).substring(0,3)})

DIAGNOSI: ${topography}
H. PYLORI: ${hpStatus}
DISPLASIA: ${getDysplasiaText(dysplasia)}${miTypeSection}
${(hasChemical || hasAutoimmune || hasLymphocytic || hasEosinophilic) ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FORME SPECIALI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${hasChemical ? `GASTROPATIA CHIMICA/REATTIVA: Iperplasia foveolare ${specialForms.chemical.foveolarHyperplasia !== null ? gradeText(specialForms.chemical.foveolarHyperplasia) : 'n.v.'}, edema LP ${specialForms.chemical.laminaEdema ? '+' : '-'}, prolif.muscolare ${specialForms.chemical.smoothMuscleProlif ? '+' : '-'}
â†’ Pattern reattivo (reflusso biliare/FANS/alcol)
` : ''}${hasAutoimmune ? `GASTRITE AUTOIMMUNE: Corpo-predominante ${specialForms.autoimmune.corpusRestricted ? 'sÃ¬' : 'no'}, metaplasia pseudopilorica ${specialForms.autoimmune.pseudopyloricMeta ? '+' : '-'}, iperplasia ECL ${specialForms.autoimmune.eclHyperplasia ? '+' : '-'}
â†’ Pattern autoimmune (anemia perniciosa, anticorpi anti-cellule parietali)
${specialForms.autoimmune.pseudopyloricMeta ? 'NOTA: Metaplasia pseudopilorica NON contribuisce a OLGIM (solo MI vera)' : ''}
` : ''}${hasLymphocytic ? `GASTRITE LINFOCITARIA: IEL aumentati (â‰¥20â€“25/100 cell. epiteliali)
â†’ Associazioni: gastrite variolariforme, celiachia (20-40%), MÃ©nÃ©trier
` : ''}${hasEosinophilic ? `GASTRITE EOSINOFILA: Eosinofili ${specialForms.eosinophilic.eosinophilsHPF === 3 ? 'â‰¥30/HPF (soglia critica superata)' : specialForms.eosinophilic.eosinophilsHPF === 2 ? '20-29/HPF (moderatamente aumentati)' : specialForms.eosinophilic.eosinophilsHPF === 1 ? '10-19/HPF (lievemente aumentati)' : '<10/HPF'}
â†’ DD: parassitosi (Anisakis), farmaci (PPI/FANS), IBD, vasculiti, neoplasie
` : ''}` : ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STAGING OLGA/OLGIM (Rugge 2007, Capelle 2010)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Metodo OLGA: ${methodDesc[method]} | Incisura aggregata ad antro
NOTA PROTOCOLLO: Staging valido solo con campionamento adeguato di TUTTE le sedi (antro+corpo)

           Score Antro  Score Corpo  Stadio  Rischio
OLGA          ${olgaAntrum}           ${olgaCorpus}           ${olgaStage}      ${olgaRisk}
OLGIM         ${olgimAntrum}           ${olgimCorpus}           ${olgimStage}      ${olgimRisk}
${hasDiscordance ? '\nâš ï¸ DISCORDANZA â‰¥2 stadi OLGA/OLGIM â†’ considerare stadio piÃ¹ alto' : ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FOLLOW-UP (MAPS II - ESGE/ESP 2019)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${riskAssessment}

${followUpText}${freeNotesSection}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BIBLIOGRAFIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Dixon MF+ 1996 (Sydney System) PMID:8827022 | Rugge M+ 2007 (OLGA) PMID:17142647
Capelle LG+ 2010 (OLGIM) PMID:20975341 | Pimentel-Nunes P+ 2019 (MAPS II) PMID:30841008

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Tool Sydney-OLGA/OLGIM v3.0 | SC Anatomia Patologica, ASST Fatebenefratelli-Sacco`;
      }
      
      document.getElementById('reportText').textContent = report;
      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // TODO v3.1: Export dati caso per analisi retrospettive
      // window.lastCase = { data, olgaStage, olgimStage, topography, specialForms, timestamp: new Date().toISOString() };
    }
    
    function copyReport() {
      const text = document.getElementById('reportText').textContent;
      if (!text || text === '') {
        showAlert('error', 'âš ï¸ Calcola prima il referto');
        return;
      }
      
      navigator.clipboard.writeText(text)
        .then(() => showAlert('success', 'âœ… Referto copiato negli appunti'))
        .catch(() => {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showAlert('success', 'âœ… Referto copiato');
        });
    }
    
    // ============================================
    // QUICK FILL FUNCTIONS
    // ============================================
    
    function setAllMetaplasiaZero() {
      document.getElementById('an_metaplasia').value = '0';
      document.getElementById('co_metaplasia').value = '0';
      document.getElementById('in_metaplasia').value = '0';
      showAlert('success', 'âœ… Metaplasia settata a 0 in tutte le sedi');
      saveFormData();
    }
    
    function setNegativeCase() {
      // Setta tutto a 0 (caso completamente negativo)
      const fields = [
        'an_chronic', 'an_activity', 'an_atrophy', 'an_metaplasia', 'an_hp',
        'co_chronic', 'co_activity', 'co_atrophy', 'co_metaplasia', 'co_hp',
        'in_chronic', 'in_activity', 'in_atrophy', 'in_metaplasia', 'in_hp'
      ];
      
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '0';
      });
      
      // Displasia assente
      document.getElementById('dysplasia').value = '0';
      
      showAlert('success', 'âœ… Caso negativo standard: tutti i campi settati a 0');
      saveFormData();
    }
    
    function setHPyCase() {
      // Gastrite lieve H. pylori+ (caso piÃ¹ comune)
      // Infiltrato cronico lieve, HP lieve, tutto il resto assente
      
      // Infiltrato cronico lieve (1) in antro e incisura
      document.getElementById('an_chronic').value = '1';
      document.getElementById('in_chronic').value = '1';
      document.getElementById('co_chronic').value = '0';
      
      // H. pylori lieve (1) in antro
      document.getElementById('an_hp').value = '1';
      document.getElementById('in_hp').value = '0';
      document.getElementById('co_hp').value = '0';
      
      // Tutto il resto a 0
      const zeroFields = [
        'an_activity', 'an_atrophy', 'an_metaplasia',
        'co_activity', 'co_atrophy', 'co_metaplasia',
        'in_activity', 'in_atrophy', 'in_metaplasia'
      ];
      
      zeroFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '0';
      });
      
      // Displasia assente
      document.getElementById('dysplasia').value = '0';
      
      showAlert('success', 'âœ… Gastrite lieve H. pylori+: precompilato pattern antro-predominante');
      saveFormData();
    }
    
    function resetForm() {
      document.querySelectorAll('select').forEach(el => el.value = '');
      document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
      const freeNotesEl = document.getElementById('free_notes');
      if (freeNotesEl) freeNotesEl.value = '';
      document.getElementById('resultsSection').style.display = 'none';
      clearErrors();
      document.getElementById('warningAlert').classList.remove('show');
      document.querySelector('input[name="olga_method"][value="atrophy"]').checked = true;
      // Chiudi sezione forme speciali
      const specialFormsContent = document.getElementById('specialFormsContent');
      const specialFormsToggle = document.getElementById('specialFormsToggle');
      if (specialFormsContent) specialFormsContent.style.display = 'none';
      if (specialFormsToggle) specialFormsToggle.textContent = 'â–¼';
      // Pulisci localStorage
      localStorage.removeItem('gastritisFormData');
    }
    
    // ============================================
    // LOCALSTORAGE - SALVATAGGIO AUTOMATICO
    // ============================================
    
    function saveFormData() {
      try {
        const formData = {
          // Metodo OLGA
          method: document.querySelector('input[name="olga_method"]:checked')?.value || 'atrophy',
          briefReport: document.getElementById('brief_report')?.checked || false,
          
          // Dati Sydney
          antrum: {
            chronic: getValue('an_chronic'),
            activity: getValue('an_activity'),
            atrophy: getValue('an_atrophy'),
            metaplasia: getValue('an_metaplasia'),
            hp: getValue('an_hp')
          },
          corpus: {
            chronic: getValue('co_chronic'),
            activity: getValue('co_activity'),
            atrophy: getValue('co_atrophy'),
            metaplasia: getValue('co_metaplasia'),
            hp: getValue('co_hp')
          },
          incisura: {
            chronic: getValue('in_chronic'),
            activity: getValue('in_activity'),
            atrophy: getValue('in_atrophy'),
            metaplasia: getValue('in_metaplasia'),
            hp: getValue('in_hp')
          },
          
          // Altri campi
          dysplasia: getValue('dysplasia'),
          miType: getStringValue('mi_type'),
          
          // Forme speciali
          foveolarHyperplasia: getValue('foveolar_hyperplasia'),
          laminaEdema: document.getElementById('lamina_edema')?.checked || false,
          smoothMuscleProlif: document.getElementById('smooth_muscle_prolif')?.checked || false,
          corpusRestricted: document.getElementById('corpus_restricted')?.checked || false,
          pseudopyloricMeta: document.getElementById('pseudopyloric_meta')?.checked || false,
          eclHyperplasia: document.getElementById('ecl_hyperplasia')?.checked || false,
          highIELs: document.getElementById('high_iels')?.checked || false,
          eosinophilsHPF: getValue('eosinophils_hpf'),
          
          // Note libere
          freeNotes: document.getElementById('free_notes')?.value || '',
          
          // Timestamp
          savedAt: new Date().toISOString()
        };
        
        localStorage.setItem('gastritisFormData', JSON.stringify(formData));
      } catch (e) {
        console.warn('Errore salvataggio localStorage:', e);
      }
    }
    
    function loadFormData() {
      try {
        const saved = localStorage.getItem('gastritisFormData');
        if (!saved) return;
        
        const data = JSON.parse(saved);
        
        // Metodo OLGA
        const methodRadio = document.querySelector(`input[name="olga_method"][value="${data.method}"]`);
        if (methodRadio) methodRadio.checked = true;
        
        if (document.getElementById('brief_report')) {
          document.getElementById('brief_report').checked = data.briefReport;
        }
        
        // Dati Sydney
        const setValue = (id, val) => {
          const el = document.getElementById(id);
          if (el && val !== null && val !== undefined) el.value = val;
        };
        
        setValue('an_chronic', data.antrum.chronic);
        setValue('an_activity', data.antrum.activity);
        setValue('an_atrophy', data.antrum.atrophy);
        setValue('an_metaplasia', data.antrum.metaplasia);
        setValue('an_hp', data.antrum.hp);
        
        setValue('co_chronic', data.corpus.chronic);
        setValue('co_activity', data.corpus.activity);
        setValue('co_atrophy', data.corpus.atrophy);
        setValue('co_metaplasia', data.corpus.metaplasia);
        setValue('co_hp', data.corpus.hp);
        
        setValue('in_chronic', data.incisura.chronic);
        setValue('in_activity', data.incisura.activity);
        setValue('in_atrophy', data.incisura.atrophy);
        setValue('in_metaplasia', data.incisura.metaplasia);
        setValue('in_hp', data.incisura.hp);
        
        setValue('dysplasia', data.dysplasia);
        setValue('mi_type', data.miType);
        
        // Forme speciali
        setValue('foveolar_hyperplasia', data.foveolarHyperplasia);
        if (document.getElementById('lamina_edema')) {
          document.getElementById('lamina_edema').checked = data.laminaEdema;
        }
        if (document.getElementById('smooth_muscle_prolif')) {
          document.getElementById('smooth_muscle_prolif').checked = data.smoothMuscleProlif;
        }
        if (document.getElementById('corpus_restricted')) {
          document.getElementById('corpus_restricted').checked = data.corpusRestricted;
        }
        if (document.getElementById('pseudopyloric_meta')) {
          document.getElementById('pseudopyloric_meta').checked = data.pseudopyloricMeta;
        }
        if (document.getElementById('ecl_hyperplasia')) {
          document.getElementById('ecl_hyperplasia').checked = data.eclHyperplasia;
        }
        if (document.getElementById('high_iels')) {
          document.getElementById('high_iels').checked = data.highIELs;
        }
        setValue('eosinophils_hpf', data.eosinophilsHPF);
        
        // Note libere
        if (document.getElementById('free_notes')) {
          document.getElementById('free_notes').value = data.freeNotes || '';
        }
        
      } catch (e) {
        console.warn('Errore caricamento localStorage:', e);
      }
    }
    
    // Carica dati salvati al caricamento pagina
    window.addEventListener('DOMContentLoaded', () => {
      loadFormData();
      
      // Event listener per tipo MI "Assente" â†’ setta tutti campi metaplasia a 0
      const miTypeSelect = document.getElementById('mi_type');
      if (miTypeSelect) {
        miTypeSelect.addEventListener('change', function() {
          if (this.value === 'absent') {
            setAllMetaplasiaZero();
          }
        });
      }
      
      // Salva automaticamente ad ogni cambio
      document.querySelectorAll('select, input, textarea').forEach(el => {
        el.addEventListener('change', saveFormData);
      });
    });
  </script>
</body>
</html>
